<!DOCTYPE html>
<meta charset=ISO-8859-1>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  width: 960px;
  height: 500px;
  position: relative;
}

.provincias {
  fill: #ccc;
  stroke: #fff;
}
div.tooltip {
  position: absolute;
  text-align: center;


  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  pointer-events: none;
}

.option-select {
  margin-top: 20px;
  margin-left: 40px;
  fill: #64b646;
  width: auto;
}
 .legend rect{
      stroke: #000;
    }

    .legend, .legend_title text{
      font-size:10pt;
    }

</style>

<div id="selectors"></div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-composite-projections/0.3.5/conicConformalSpain-proj.min.js"></script>
<script>
function normalize(s) {
var r=s.toLowerCase();
            r = r.replace(new RegExp(/\s/g),"");
            r = r.replace(new RegExp(/[àáâãäå]/g),"a");
            r = r.replace(new RegExp(/[èéêë]/g),"e");
            r = r.replace(new RegExp(/[ìíîï]/g),"i");
            r = r.replace(new RegExp(/ñ/gi),"n");                
            r = r.replace(new RegExp(/[òóôõö]/g),"o");
            r = r.replace(new RegExp(/[ùúûü]/g),"u");
            
 return r;
}


var width = "1500",
    height ="800";

var projection = d3.geo.conicConformalSpain().scale(4000).translate([width/2, height/2]);

var path = d3.geo.path()
.projection(projection);
  d3.json("https://raw.githubusercontent.com/antoniofenna/test/master/provincias.json", function(error, provincias) {
var dsv = d3.dsv(';')
dsv("https://raw.githubusercontent.com/antoniofenna/test/master/prueba.csv", function(error, offers) {
 var option_select = d3.select('#selectors').append("select")
      .attr("name", "selector")
      .attr("class", "option-select");
 var land = topojson.feature(provincias, provincias.objects.provincias);
var year = offers[0].year;
offers.forEach(function (d){
var opt = option_select.append("option")
        .attr("value", d.year)
        .text(d.year);
});
var usedNames = {};
$("select[name='selector'] > option").each(function () {
  if(usedNames[this.text]) {
     $(this).remove();
 } else {
     usedNames[this.text] = this.value;
 }});

drawMap(year);
       option_select.on("change", function() {
 	d3.select("svg").remove();
      drawMap($("#selectors").find(".option-select").val());
    });

function drawMap(data){
var colores=[];
land.features.forEach(function (d){
var maximo=0;
offers.forEach(function (dat){

 if(maximo<dat.number_offers && dat.year==data && dat.city.toUpperCase() == normalize(d.properties.nombre).toUpperCase()){
	maximo=dat.number_offers;
}
 if(maximo == 0){
    maximo = 1;
}
 colores[d.properties.nombre]=d3.interpolate("#88C3F7", "#013BFD")(maximo/50);
});
});


var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
svg.selectAll("path")
      .data(land.features)
      .enter()
      .append("path")
      .attr("d", path)
      .attr("fill", function(d){
        return colores[d.properties.nombre];
       }).on("mouseover", function(d) {
            d3.select(this)
                .transition()
                .style("stroke-width", 4);

            div.transition()
                .duration(200)
                .style("opacity", 0.9);
            var offers_text  = "";
 	    var max_length = 0;
            offers.forEach(function (dat){
	      if(dat.year == data && dat.city.toUpperCase() == normalize(d.properties.nombre).toUpperCase()){
              offers_text += dat.tech + ": " + dat.number_offers + "</br>";
	      if(max_length < dat.tech.length+dat.number_offers+2){
	       max_length = dat.tech.length+dat.number_offers+2;
	      }
		}
            });
	    div.attr("width", max_length+"px");
            div.html("Resultados: <br/>" + offers_text)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
            })
.on("mouseout", function(d) {
            d3.select(this)
                .transition()
                .style("stroke-width", 0);
            div.transition()
                .duration(500)
                .style("opacity", 0);
        });

        svg
          .append("path")
            .style("fill","none")
            .style("stroke","#000")
            .attr("d", projection.getCompositionBorders());

}  

  });
  });

</script>